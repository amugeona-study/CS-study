# 2.2 TCP/IP 4계층 모델

TCP: Transmission Control Protocol

IP: Internet Protocol

## 2.2.1 계층 구조

TCP/IP 계층은 4개의 계층을 가지고 있음

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image.png)

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%201.png)

### 어플리케이션 계층

FTP, HTTP, SSH, SMTP, DNS 등 응용 프로그램이 사용되는 프로토콜 계층

웹서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 계층

- **FTP**: 파일 전송 프로토콜
- **HTTP**: 웹 통신을 위한 프로토콜
- **SSH**: 암호화 네트워크 프로토콜
- **SMTP**: 이메일 전송 프로토콜
- **DNS**: 도메인 이름을 IP주소로 변환하는 프로토콜

### 전송 계층

송신자와 수신자를 연결하는 통신 서비스 제공

연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공

대표적인 예시: TCP, UDP

- **TCP**: 패킷 순서 보장, 수신 여부 확인, 가상회선 패킷 교환 방식
- **UDP**: 순서 보장 X, 수신여부 파악 X, 데이터그램 패킷 교환 방식

- **가상회선 패킷 교환 방식**
  : 패킷이 지정된 같은 회선을 따라 순서대로 도착, 모든 패킷이 도착하면 가상 회선이 해제 됨
  ![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%202.png)
- **데이터그램 패킷 교환 방식**
  : 패킷이 독립적으로 이동, 최적의 경로를 선택해서 감 (서로 다른 경로로 전송 될 수 있음)
  ![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%203.png)

### TCP 연결 성립 과정

신뢰성을 확보할 때, **`3-way-handshake`** 작업을 진행한다.

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%204.png)

1. **SYN 단계**: 클라이언트가 **`클라이언트의 ISN`**을 담아 **`SYN`**을 전송.
2. **SYN + ACK 단계**: 서버는 **SYN**을 수신하고 **`서버의 ISN`**와 승인번호로 **`클라이언트의 ISN + 1`** 전송
3. **ACK 단계**: 클라이언트는 **`서버의 ISN + 1`**한 값인 승인번호를 담아 **`ACK`**를 서버에 전송

<aside>

- SYN(SYNchronization): 연결요청 플래그
- ACK(ACKnowledgement): 응답 플래그
- ISN(Initial Sequence Numbers): 초기 네트워크 연결 시 할당된 시퀀스 번호(32비트)
</aside>

### TCP 연결 해제 과정

**`4-way-handshake`** 작업을 진행한다.

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%205.png)

1. 클라이언트가 **`FIN`** 세그먼트 전송, **`FIN_WAIT_1`** 상태로 들어가고 서버의 응답 대기
2. 서버는 클라이언트로 **`ACK`** 승인 세그먼트 전송, **`CLOSE_WAIT`** 상태

   클라이언트는 세그먼트를 받으면 **`FIN_WAIT_2`** 상태

3. 서버는 ACK를 보내고 **일정 시간 이후**에 클라이언트에 **`FIN`** 세그먼트 전송
4. 클라이언트는 **`TIME_WAIT`** 상태가 되고 다시 서버로 **`ACK`**를 보내서 서버는 **`CLOSED`** 상태가 된다.

   이후 클라이언트는 일정 시간 대기 후, 연결이 닫히고 클라이언트와 서버의 모든 자원의 연결 해제

<aside>

**TIME_WAIT**: 소켓이 바로 소멸되지 않고 일정시간 유지되는 상태 (Ubuntu 60초, 윈도우 4분)

1. 지연 패킷 발생 경우를 대비하기 위함.

   대기 없이 바로 닫힌 후, 같은 포트로 새로운 연결이 열리면 지연 패킷이 잘못 처리 될 수 있음 (데이터 무결성 문제 발생)

2. 두 장치간의 연결이 닫혔는지 확인하기 위함.

   **LAST_ACK** 상태에서 종료된다면, 완전히 종료되지 않은 것으로 간주되어 새 연결이 실패하거나 접속오류가 발생 할 수 있음

</aside>

### 인터넷 계층

장치로부터 받은 **네트워크 패킷**을 IP 주소로 **지정된 목적지로 전송**하기 위해 사용되는 계층 (IP, ARP, ICMP 등)

상대방이 제대로 받았는지에 대해 보장하지 않음(**비연결형적**)

### 링크 계층 (네트워크 엑세스 계층)

전선, 광섬유, 무선 등으로 **실질적으로 데이터를 전달**하며 장치 간에 신호를 주고받는 ‘**규칙**’을 정하는 계층

- **유선 LAN(IEEE802.3)**
  - 유선 LAN을 이루는 **`이더넷`**은 IEEE802.3프로토콜을 따르며 **전이중화 통신**을 사용
  - **`전이중화 통신(full duplex)`**: 양쪽 장치가 **동시에 송수신**할 수 있는 방식
  - 유선 LAN 케이블
    - 트위스트 페어 케이블
    - 광섬유 케이블
- **무선 LAN(IEEE802.11)**
  - 수신과 송신이 같은 채널 사용 → **반이중화 통신** 사용
  - **`반이중화 통신(half duplex)`**: 양쪽 장치는 서로 통신할 수 있지만, **동시에는 통신할 수 없으며** 한 번에 한 방향만 통신할 수 있는 방식
    - **CSMA/CA**: 데이터를 보내기 전에 캐리어 감지 등으로 사전에 가능한 한 충돌을 방지하는 방식
  - 무선 LAN을 이루는 주파수
    - WLAN, Wireless Local Area Network: 무선 신호 전달 방식을 이용(2.4GHz, 5GHz)
      - **wifi**: 전자기기들이 무선 LAN 신호에 연결할 수 있게 하는 기술
      - **BSS(Basic Service Set)**: 동일 BSS 내에 있는 AP들과 장치들이 서로 통신이 가능한 구조
      - **ESS(Extended Service Set)**: 하나 이상의 연결된 BSS 그룹
        ![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%206.png)

### 이더넷 프레임

데이터 링크 계층은 이더넷 프레임을 통해 전달받은 데이터의 에러를 검출하고 캡슐화하여 다음과 같은 구조를 가진다.

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%207.png)

- **Preamble**: 이더넷 프레임의 시작을 알림
- **SFD(Start Frame Delimiter)**: 다음 바이트부터 MAC 주소 필드가 시작됨을 알림
- **DMAC,** **SMAC**: 수신, 송신 MAC 주소를 말합니다.
- **EtherType**: 데이터 계층 위의 계층인 IP 프로토콜을 정의(IPv4, IPv6)
- **Payload**: 전달받은 데이터
- **CRC**: 에러 확인 비트

### 계층 간 데이터 송수신 과정

HTTP를 통해 웹 서버에 있는 데이터를 요청했을때

![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%208.png)

요청 → **캡슐화** → 전달 → **비캡슐화** → 데이터 전송

- **캡슐화**
  **상위 계층의 헤더와 데이터**를 **하위 계층의 데이터 부분에 포함**시키고 해당 계층의 헤더를 삽입하는 과정
  ![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%209.png)
- **비캡슐화**
  하위 계층에서 상위 계층으로 가며 각 계층의 **헤더 부분을 제거하는 과정**
  ![image.png](2%202%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2012695e1642d1806da333ddc04e0a9678/image%2010.png)
  최종적으로 사용자에게 애플리케이션의 PDU인 **메시지로 전달**

## 2.2.2 PDU

**PDU(Protocol Data Unit)** : 네트워크의 계층에서 계층으로 데이터가 전달 될 때, 한 덩어리의 단위

**헤더**와 **페이로드**로 구성되어있으며 계층마다 명칭이 다름

- 어플리케이션 계층: **메세지**
- 전송 계층: **세그먼트**(TCP), **데이터그램**(UDP)
- 인터넷 계층: **패킷**
- 링크 계층: **프레임**(데이터 링크 계층), **비트**(물리 계층)

ex. 어플리케이션 계층은 메세지 기반으로 데이터를 전달함 → HTTP의 헤더는 문자열

<aside>
💡

PDU중 가장 아래 계층인 **비트**로 송수신하는 것이 모든 PDU중 **가장 빠르고 효율성이 높다**. 그러나 어플리케이션 계층에서는 문자열로 송수신을 하는데, 이는 헤더에 authorization 값 등 **다른 값들을 넣는 확장**이 쉽기 때문이다.

</aside>
